@model SpmsApp.ViewModels.PloComparisonCourseWithSelectPlosViewModel;
@{
    ViewData["Title"] = "Dashboard";
}

<div class="row">
    <div class="col">@Html.Partial("TopBar", Model.TopbarViewModel)</div>
</div>
<div class="row" style="height: 100%;">
    <div class="col-2">
        @Html.Partial("FacultySidebar")
    </div>
    <div class="col">
        <label>Select Starting Semester: </label>
        <select asp-items=@Html.GetEnumSelectList(typeof(SpmsApp.Models.SemesterName)) id="start-semester"></select>
        <input type="number" placeholder="Starting Year" id="start-year" required>

        <br>

        <label>Select Ending Semester: </label>
        <select asp-items=@Html.GetEnumSelectList(typeof(SpmsApp.Models.SemesterName)) id="end-semester"></select>
        <input type="number" placeholder="Starting Year" id="end-year" required>

        <br>

        <label>Select Course(s):</label>
        <select id="course" required>
            <option>Select a Course</option>
            @foreach (var course in Model.Courses)
            {
                <option value=@course.CourseID>@($"{course.CourseCode} - {course.CourseName} - {course.Program.ProgramCode}")</option>
            }
        </select>
        <button class="btn btn-primary" id="add-course-btn"><i class="fas fa-plus"></i></button>
        <p id="selected-courses"></p>

        <label>Select PLO(s):</label>
        <select id="plo" required>
            <option>Select a PLO</option>
            <option value="PLO-01">PLO-01</option>
            <option value="PLO-02">PLO-02</option>
            <option value="PLO-03">PLO-03</option>
            <option value="PLO-04">PLO-04</option>
            <option value="PLO-05">PLO-05</option>
            <option value="PLO-06">PLO-06</option>
            <option value="PLO-07">PLO-07</option>
            <option value="PLO-08">PLO-08</option>
            <option value="PLO-09">PLO-09</option>
            <option value="PLO-10">PLO-10</option>
            <option value="PLO-11">PLO-11</option>
            <option value="PLO-12">PLO-12</option>
        </select>
        <button class="btn btn-primary" id="add-plo-btn"><i class="fas fa-plus"></i></button>
        <p id="selected-plos"></p>
        <button id="submit-btn" class="btn btn-primary">Submit</button>
        <div style="width: 50%;" id="draw-point">

        </div>
    </div>
</div>

<script>
    let courses = @Html.Raw(Json.Serialize(Model.Courses));
    let plos = ['PLO-01','PLO-02','PLO-03','PLO-04','PLO-05','PLO-06','PLO-07','PLO-08','PLO-09','PLO-10','PLO-11','PLO-12'];
    console.log(courses);
    let selectedCourses = [];
    let course = document.querySelector("#course");
    let selectedCourseBanner = document.getElementById("selected-courses");
    let selectedPlos = [];
    let plo = document.getElementById("plo");
    let selectedPlosBanner = document.getElementById("selected-plos");

    document.querySelector("#add-course-btn").addEventListener('click', e => {
        e.preventDefault();
        let value = parseInt(course.value);
        if (course.value != null && !selectedCourses.includes(value)) {
            selectedCourses.push(value);
            let c = courses.find(el => el.courseID == selectedCourses[0]);
            selectedCourseBanner.innerText = `Selected Course(s): ${c.courseName} (${c.program.programCode})`;
            for (let i = 1; i < selectedCourses.length; i++) {
                c = courses.find(el => el.courseID == selectedCourses[i]);
                selectedCourseBanner.innerText += `, ${c.courseName} (${c.program.programCode})`;
            }
        }
    });

    document.querySelector("#add-plo-btn").addEventListener('click', e => {
        e.preventDefault();
        if (plo.value != null && !selectedPlos.includes()) {
            selectedPlos.push(plo.value);
            let pIdx = plos.findIndex(el => el === selectedPlos[0]);
            selectedPlosBanner.innerText = `Selected PLO(s): ${plos[pIdx]}`;

            for (let i = 1; i < selectedPlos.length; i++) {
                pIdx = plos.findIndex(el => el === selectedPlos[i]);
                selectedPlosBanner.innerText += `, ${plos[pIdx]}`;
            }
        }
    });

    document.getElementById("submit-btn").addEventListener('click', e =>
    {
        e.preventDefault();

        let startSemester = document.getElementById("start-semester").value;
        let startYear = document.getElementById("start-year").value;
        let endSemester = document.getElementById("end-semester").value;
        let endYear = document.getElementById("end-year").value;

        if (startYear === null) startYear = 0;
        if (endYear === null) endYear = 9999;

        let data =
        {
            SelectedCoursesID: selectedCourses,
            SelectedPlosName: selectedPlos
        };

        console.log(data);

        fetch(`/faculty/pccsp/${startSemester}/${startYear}/${endSemester}/${endYear}`, 
        {
            method: 'post',
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(res => 
        {
            console.log(res);
            let drawPoint = document.getElementById('draw-point');
            drawPoint.innerHTML = "";

            var ctx = document.createElement('canvas');
            ctx.getContext('2d');
            drawPoint.appendChild(ctx);

            var myChart = new Chart(ctx, 
            {
                type: 'bar',
                data: {
                    labels: res.labels,
                    datasets: [{
                        label: 'No. of Students',
                        data: res.data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                offset: true
                            }
                        },
                        x: {
                            grid: {
                                offset: true
                            }
                        }
                    }
                }
            })
        });
    })
</script>